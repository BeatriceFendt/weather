name: meteo
version: '0.6.1'
summary: Know the forecast of the next hours and days, with data and maps
description: |
  Current weather, with information about temperature, pressure, wind
  speed and direction, sunrise and sunset. Show awesome maps with all
  this information. Switch between some maps distributors.
grade: devel
confinement: devmode

icon: data/com.github.bitseater.weather.svg

plugs:
  elementary-platform-loki:
    interface: content
    target: $SNAP/gnome-platform
    default-provider: elementary-platform-loki:elementary-platform-loki

apps:
  meteo:
    command: bin/desktop-launch bin/snapcraft-preload $SNAP/usr/bin/com.github.bitseater.weather
    plugs:
      - x11
      - desktop
      - desktop-legacy
      - wayland
      - unity7
      - home
      - browser-support
      - locale-control
      - gsettings
      - network
      - opengl
    desktop: usr/share/applications/com.github.bitseater.weather.desktop
    environment:
      GSETTINGS_SCHEMA_DIR: $SNAP/share/glib-2.0/schemas
      LD_LIBRARY_PATH: $SNAP/usr/lib/*/webkit2gtk-4.0/:$LD_LIBRARY_PATH

parts:
  elementary:
    plugin: nil
    prepare: |
      apt install -y software-properties-common
      add-apt-repository -y ppa:elementary-os/stable
      add-apt-repository -y ppa:elementary-os/os-patches
      echo "Package: *" > /etc/apt/preferences.d/elementary-stable
      echo "Pin: release o=LP-PPA-elementary-os-stable" >> /etc/apt/preferences.d/elementary-stable
      echo "Pin-Priority: 1000" >> /etc/apt/preferences.d/elementary-stable
      echo "Package: *" > /etc/apt/preferences.d/elementary-patches
      echo "Pin: release o=LP-PPA-elementary-os-os-patches" >> /etc/apt/preferences.d/elementary-patches
      echo "Pin-Priority: 1000" >> /etc/apt/preferences.d/elementary-patches
      apt update
      apt dist-upgrade -y --allow-downgrades
      apt install -y meson
      apt install -y valac

  granite:
    plugin: cmake
    source: https://github.com/elementary/granite/archive/0.4.1.tar.gz
    source-type: tar
    configflags: [-DCMAKE_BUILD_TYPE=Release, -DCMAKE_INSTALL_PREFIX=/usr, -DCMAKE_INSTALL_LIBDIR=/usr/lib]
    build-packages:
      - build-essential
      - valac
    stage-packages:
      - valac-0.30-vapi

  meteo:
    after: [elementary, granite, desktop-gtk3, snapcraft-preload]
    source: https://github.com/bitseater/weather.git
    source-type: git
    plugin: meson
    meson-parameters: [--prefix=/usr]
    build-packages:
      - appstream
      - desktop-file-utils
      - build-essential
      - gettext
      - libgee-0.8-dev
      - libgtk-3-dev
      - libglib2.0-dev
      - valac
      - libjson-glib-dev
      - meson
      - ninja-build
      - debhelper
      - libgranite-dev
      - libsoup2.4-dev
      - libgeocode-glib-dev
      - libclutter-1.0-dev
      - libclutter-gtk-1.0-dev
      - libchamplain-0.12-dev
      - libwebkit2gtk-4.0-dev
      - libappindicator3-dev
    stage-packages:
      - locales-all
      - libgdk-pixbuf2.0-0
      - libclutter-1.0-0
      - libclutter-gtk-1.0-0
      - libchamplain-0.12-0
      - libgeocode-glib0
      - libwebkit2gtk-4.0-37
      - libappindicator3-1
      - libcanberra-gtk3-module
    filesets:
      exclude:
        - -lib/*/libglib-2.0.so.0.4800.2
        - -usr/lib/*/glib-2.0/gio-querymodules
        - -usr/lib/*/glib-2.0/glib-compile-resources
        - -usr/lib/*/glib-2.0/glib-compile-schemas
        - -usr/lib/*/libgio-2.0.so.0.4800.2
        - -usr/lib/*/libgmodule-2.0.so.0.4800.2
        - -usr/lib/*/libgobject-2.0.so.0.4800.2
        - -usr/lib/*/libgthread-2.0.so.0.4800.2
        - -usr/share/doc/hicolor-icon-theme/NEWS.gz
        - -usr/share/doc/hicolor-icon-theme/changelog.Debian.gz
        - -usr/share/doc/libglib2.0-0/changelog.Debian.gz
        - -usr/share/icons/hicolor/index.theme
      stage:
        - $exclude
